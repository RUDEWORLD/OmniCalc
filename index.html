<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Apple Silicon to E2 Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/PptxGenJS@3.12.0/dist/pptxgen.bundle.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, rgb(20, 35, 70), rgb(35, 55, 100));
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Navigation Bar */
        .nav-bar {
            background-color: rgb(20, 35, 70);
            padding: 15px 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-title {
            font-size: 20px;
            font-weight: 600;
            color: white;
        }

        /* Card Styling */
        .card {
            background: rgba(40, 60, 105, 0.5);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }

        .card-results {
            border: 1px solid rgba(0, 200, 100, 0.3);
            box-shadow: 0 8px 16px rgba(0, 200, 100, 0.2);
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            padding: 0 4px 12px 4px;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            user-select: none;
        }

        .section-title:hover {
            color: rgba(255, 255, 255, 0.9);
        }

        .section-chevron {
            font-size: 16px;
            transition: transform 0.3s ease, color 0.3s ease;
            color: #4ade80;
        }

        .section-chevron.collapsed {
            transform: rotate(180deg);
            color: #f87171;
        }

        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease, padding 0.3s ease;
            max-height: 2000px;
            opacity: 1;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0 !important;
            padding: 0 !important;
            border: none !important;
        }

        .section-title.collapsed-title {
            padding-bottom: 4px;
        }

        .divider.collapsed-divider {
            margin: 8px 0;
        }

        /* Row Styling */
        .row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 2px;
        }

        .row-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
            color: white;
        }

        .row-label .icon {
            font-size: 14px;
            color: #4ade80;
        }

        /* Select/Dropdown Styling */
        select {
            background: transparent;
            border: none;
            color: #4ade80;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            padding: 5px 10px;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%234ade80' d='M6 8L2 4h8z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 5px center;
            padding-right: 25px;
            text-align: right;
            direction: rtl;
        }

        select option {
            background: rgb(40, 60, 105);
            color: white;
            direction: ltr;
            text-align: right;
        }

        select option:disabled {
            color: rgba(255, 255, 255, 0.1);
        }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle {
            position: relative;
            width: 44px;
            height: 24px;
            cursor: pointer;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 24px;
            transition: 0.3s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle input:checked + .toggle-slider {
            background-color: #4ade80;
        }

        .toggle input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .toggle input:disabled + .toggle-slider {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Help Button */
        .help-btn {
            background: none;
            border: none;
            color: rgba(59, 130, 246, 0.8);
            font-size: 16px;
            cursor: pointer;
            padding: 0;
            margin-left: 4px;
        }

        .help-btn:hover {
            color: rgba(59, 130, 246, 1);
        }

        /* Warning Text */
        .warning-text {
            font-size: 11px;
            color: #f97316;
            padding-left: 28px;
            margin-top: 4px;
        }

        /* Divider */
        .divider {
            height: 1px;
            background: rgba(128, 128, 128, 0.5);
            margin: 20px 0;
        }

        .card-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.2);
            margin: 12px 0;
        }

        /* Configuration Limits */
        .limit-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .limit-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }

        .limit-label .icon {
            font-size: 14px;
            color: #4ade80;
        }

        .limit-value {
            font-size: 16px;
            font-weight: 600;
            color: #4ade80;
        }

        /* Input Fields */
        input[type="text"],
        input[type="number"] {
            background: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 15px;
            color: #333;
            width: 150px;
            text-align: right;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #4ade80;
        }

        .input-small {
            width: 80px;
        }

        /* Calculate Button */
        .calculate-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(90deg, rgb(50, 100, 200), rgb(70, 130, 220));
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            text-align: center;
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .calculate-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 7px 20px rgba(59, 130, 246, 0.4);
        }

        .calculate-btn:active {
            transform: translateY(0);
        }

        .calculate-btn-subtitle {
            font-size: 11px;
            font-weight: 400;
            opacity: 0.8;
            margin-top: 2px;
        }

        /* Results Section */
        .result-main {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }

        .result-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }

        .result-value {
            font-size: 14px;
            font-weight: 600;
            color: white;
        }

        .result-value-main {
            font-size: 18px;
            font-weight: 700;
        }

        .result-value-success {
            color: #4ade80;
        }

        /* EDID Timings Button */
        .edid-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(90deg, rgb(60, 120, 180), rgb(80, 140, 200));
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 8px;
        }

        .edid-btn:hover {
            opacity: 0.9;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 10px 0;
            font-size: 12px;
            font-weight: 700;
            color: white;
        }

        .disclaimer {
            text-align: center;
            font-size: 12px;
            font-weight: 700;
            color: rgb(200, 100, 100);
            padding: 10px 0 20px 0;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: linear-gradient(135deg, rgb(20, 35, 70), rgb(35, 55, 100));
            border-radius: 16px;
            padding: 20px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-subtitle {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .timing-section {
            margin-bottom: 20px;
        }

        .timing-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .timing-row {
            display: flex;
            padding: 4px 0;
        }

        .timing-label {
            width: 120px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }

        .timing-value {
            font-size: 14px;
            font-weight: 600;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
        }

        /* Alert Modal */
        .alert-modal {
            background: rgb(40, 60, 105);
            border-radius: 14px;
            padding: 20px;
            max-width: 300px;
            text-align: center;
        }

        .alert-title {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .alert-message {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .alert-btn {
            background: rgba(59, 130, 246, 0.8);
            border: none;
            border-radius: 8px;
            padding: 10px 30px;
            color: white;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Blink Effect */
        .blink-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 999;
            transition: opacity 0.1s ease-in-out;
        }

        .blink-overlay.active {
            opacity: 0.2;
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Reset Button */
        .reset-btn {
            display: block;
            margin: 12px auto 0 auto;
            padding: 8px 24px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
        }

        .reset-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Export Button */
        .export-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(90deg, rgb(80, 140, 80), rgb(100, 160, 100));
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 16px;
            transition: opacity 0.2s;
        }

        .export-btn:hover {
            opacity: 0.9;
        }

        .export-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* CSV Buttons Container */
        .csv-btn-container {
            width: calc(100% - 40px);
            max-width: 460px;
            margin: 20px auto;
            display: flex;
            gap: 10px;
        }

        /* Export/Import CSV Buttons */
        .csv-btn {
            flex: 1;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: background 0.2s, border-color 0.2s;
        }

        .csv-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .csv-file-input {
            display: none;
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            .nav-title {
                font-size: 17px;
            }

            input[type="text"],
            input[type="number"] {
                width: 120px;
            }

            .row-label {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- Blink Effect Overlay -->
    <div id="blinkOverlay" class="blink-overlay"></div>

    <!-- Navigation Bar -->
    <div class="nav-bar">
        <div class="nav-title">Apple Silicon to E2 Calculator</div>
    </div>

    <div class="container">
        <!-- System Configuration Section -->
        <div class="section-title" onclick="toggleSection('systemConfig')">
            <span>SYSTEM CONFIGURATION</span>
            <span id="systemConfigChevron" class="section-chevron">▲</span>
        </div>
        <div id="systemConfigContent" class="card collapsible-content">
            <!-- Connector -->
            <div class="row">
                <div class="row-label">Connector:</div>
                <select id="connector" onchange="onConnectorChange()">
                    <option value="HDMI 2.0">HDMI 2.0</option>
                    <option value="DP 1.2" selected>DP 1.2</option>
                </select>
            </div>

            <!-- Computer Model -->
            <div class="row">
                <div class="row-label">Computer Model:</div>
                <select id="computer" onchange="onComputerChange()">
                    <option value="" selected>-- Select --</option>
                    <option value="MacBookPro">MacBookPro</option>
                    <option value="MacStudio">MacStudio</option>
                    <option value="MacPro">MacPro</option>
                    <option value="MacMini">MacMini</option>
                </select>
            </div>

            <!-- M-Series Chip -->
            <div class="row">
                <div class="row-label">M-Series Chip:</div>
                <select id="processor" onchange="onProcessorChange()">
                    <option value="" selected>-- Select --</option>
                    <!-- Options populated by JavaScript -->
                </select>
            </div>

            <!-- macOS -->
            <div class="row">
                <div class="row-label">MacOS:</div>
                <select id="macos" onchange="onMacOSChange()">
                    <option value="" selected>-- Select --</option>
                    <!-- Options populated by JavaScript -->
                </select>
            </div>

            <!-- Connector Capacity -->
            <div class="row">
                <div class="row-label">Connector Capacity:</div>
                <select id="capacity" onchange="onCapacityChange()">
                    <option value="SL">SL</option>
                    <option value="DL">DL</option>
                    <option value="4K" selected>4K</option>
                </select>
            </div>

            <!-- Better Display -->
            <div class="row" style="flex-direction: column; align-items: stretch;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div class="row-label">
                        Better Display:
                        <button class="help-btn" onclick="showAlert('Better Display', 'Better Display is a Mac app similar to SwitchResX that allows you to load custom EDID files. You can use this software to increase the maximum display resolution of macs with custom created EDID files. Better Display has no positive impact on any M1 series processor and is disabled as an option when M1s are selected.')">&#9432;</button>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" id="betterDisplay" onchange="onBetterDisplayChange()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div id="betterDisplayWarning" class="warning-text hidden">Won't boost resolution for M1 chips</div>
            </div>

            <!-- Reset Button -->
            <button class="reset-btn" onclick="resetSystemConfig()">Reset</button>
        </div>

        <div class="divider"></div>

        <!-- Configuration Limits Section -->
        <div class="section-title" onclick="toggleSection('configLimits')">
            <span>CONFIGURATION LIMITS</span>
            <span id="configLimitsChevron" class="section-chevron">▲</span>
        </div>
        <div id="configLimitsContent" class="card collapsible-content">
            <div class="limit-row">
                <div class="limit-label">
                    Max Horizontal:
                    <button class="help-btn" onclick="showAlert('Max Horizontal Resolution', 'Maximum horizontal resolution you will be able to get out of the computer based on the specs selected above. Connector, Computer Model, M-Chip, OS, Connector capacity & Better Display all impact the maximum Horizontal resolution allowed.')">&#9432;</button>
                </div>
                <div class="limit-value" id="maxHorizontal">6144</div>
            </div>
            <div class="card-divider"></div>
            <div class="limit-row">
                <div class="limit-label">Pixel Clock:</div>
                <div class="limit-value" id="maxPixelClock">660 MHz</div>
            </div>
            <div class="card-divider"></div>
            <div class="limit-row">
                <div class="limit-label">Max Displays:</div>
                <div class="limit-value" id="maxDisplays">1</div>
            </div>
        </div>

        <div class="divider"></div>

        <!-- Resolution Calculator Section -->
        <div class="section-title" onclick="toggleSection('resCalc')">
            <span>RESOLUTION CALCULATOR</span>
            <span id="resCalcChevron" class="section-chevron">▲</span>
        </div>
        <div id="resCalcContent" class="card collapsible-content">
            <!-- Display Width -->
            <div class="row" style="background: transparent; padding: 2px 12px;">
                <div class="row-label">Display Width:</div>
                <input type="number" id="displayWidth" placeholder="Enter Width" oninput="clearResults()">
            </div>

            <!-- Display Height -->
            <div class="row" style="background: transparent; padding: 10px 12px;">
                <div class="row-label">Display Height:</div>
                <input type="number" id="displayHeight" placeholder="Enter Height" oninput="clearResults()">
            </div>

            <!-- Frame Rate -->
            <div class="row">
                <div class="row-label">Frame Rate:</div>
                <select id="frameRate" onchange="clearResults()">
                    <option value="23.98">23.98</option>
                    <option value="24">24</option>
                    <option value="25">25</option>
                    <option value="29.97">29.97</option>
                    <option value="30">30</option>
                    <option value="50">50</option>
                    <option value="59.94" selected>59.94</option>
                    <option value="60">60</option>
                </select>
            </div>

            <!-- Bit Rate -->
            <div class="row">
                <div class="row-label">Bit Rate:</div>
                <select id="bitRate" onchange="onBitRateChange()">
                    <option value="8 Bit" selected>8 Bit</option>
                    <option value="10 Bit">10 Bit</option>
                    <option value="12 Bit">12 Bit</option>
                </select>
            </div>

            <!-- Chroma Subsampling -->
            <div class="row">
                <div class="row-label">Chroma Subsampling:</div>
                <select id="chromaSubsampling" onchange="onChromaChange()">
                    <option value="4:4:4" selected>4:4:4</option>
                    <option value="4:2:2">4:2:2</option>
                </select>
            </div>

            <!-- Reduced Blanking -->
            <div class="row">
                <div class="row-label">Reduced Blanking:</div>
                <select id="reducedBlanking" onchange="clearResults()">
                    <option value="RB V1">RB V1</option>
                    <option value="RB V2" selected>RB V2</option>
                </select>
            </div>

            <!-- Dual DP 1.2 -->
            <div class="row">
                <div class="row-label">
                    Dual DP 1.2 (DisplayID Block On)
                    <button class="help-btn" onclick="showAlert('Dual DP 1.2', 'Turning on Dual DP1.2 mode adjusts calculations to account for the use of two display port cables connected between E2 and Mac with Display ID block turned on allowing E2 to trick the Mac into displaying a single display over the two DP1.2 cables. This will only work if your vertical resolution is larger than your horizontal resolution. This is most useful to gain more vertical resolution on your mac output. Please only turn this on if you understand Dual DP workflow in E2.')">&#9432;</button>
                </div>
                <label class="toggle">
                    <input type="checkbox" id="dualDp" onchange="onDualDpChange()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- Pixel Density Mode -->
            <div class="row">
                <div class="row-label">
                    Pixel Density Mode
                    <button class="help-btn" onclick="showAlert('Pixel Density Mode', 'Pixel density mode allows you to set a maximum vertical resolution for calculations. When on, the app will calculate your max resolution to maintain aspect ratio as well as all other pre defined parameters, but will also include the max V parameter. This is useful if you have displays with different pixel density and want to limit the resolution of a larger density wall to match the pixel density of the lower resolution display.')">&#9432;</button>
                </div>
                <div class="toggle-container">
                    <input type="number" id="maxVertical" placeholder="Max V" class="input-small hidden" oninput="clearResults()">
                    <label class="toggle">
                        <input type="checkbox" id="pixelDensityMode" onchange="onPixelDensityModeChange()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Calculate Button -->
        <button class="calculate-btn" onclick="calculate()">
            CALCULATE
            <div class="calculate-btn-subtitle">Tap to compute scaled resolution</div>
        </button>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden" style="margin-top: 20px;">
            <div class="section-title">RESULTS</div>
            <div class="card card-results">
                <!-- Main Result -->
                <div class="result-main">
                    <div class="result-row">
                        <div class="result-label" style="font-size: 16px;">Scaled Resolution:</div>
                        <div id="scaledResolution" class="result-value result-value-main"></div>
                    </div>
                    <div class="result-row">
                        <div class="result-label" style="font-size: 12px; color: rgba(255,255,255,0.5);">Original Resolution:</div>
                        <div id="originalResolution" class="result-value" style="font-size: 12px; color: rgba(255,255,255,0.5); font-weight: 400;"></div>
                    </div>
                    <div id="resolutionPerCableRow" class="result-row hidden">
                        <div class="result-label">Resolution Per Cable:</div>
                        <div id="resolutionPerCable" class="result-value"></div>
                    </div>
                </div>

                <!-- Other Results -->
                <div class="result-row">
                    <div class="result-label" id="clockLabel">Pixel Clock:</div>
                    <div id="pixelClockResult" class="result-value"></div>
                </div>
                <div class="result-row">
                    <div class="result-label">Original Aspect:</div>
                    <div id="originalAspect" class="result-value"></div>
                </div>
                <div class="result-row">
                    <div class="result-label">Scaled Aspect:</div>
                    <div id="scaledAspect" class="result-value"></div>
                </div>
                <div class="result-row">
                    <div class="result-label">Keynote Canvas:</div>
                    <div id="keynoteCanvas" class="result-value"></div>
                </div>
                <div class="result-row">
                    <div class="result-label">PPT Canvas (72dpi):</div>
                    <div id="pptCanvas" class="result-value"></div>
                </div>

                <!-- EDID Timings Inline -->
                <div id="edidTimingsInline" class="hidden">
                    <div class="card-divider" style="margin: 16px 0;"></div>

                    <div class="timing-title" style="margin-bottom: 8px;">EDID TIMINGS</div>
                    <div id="edidSubtitleInline" style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 4px;"></div>
                    <div id="edidCapacityInline" style="font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 12px;"></div>

                    <!-- Horizontal Timings -->
                    <div class="timing-section">
                        <div class="timing-title" style="font-size: 13px;">HORIZONTAL</div>
                        <div class="timing-row">
                            <div class="timing-label">H Total:</div>
                            <div id="hTotalInline" class="timing-value"></div>
                        </div>
                        <div class="timing-row">
                            <div class="timing-label">H Front Porch:</div>
                            <div id="hFrontPorchInline" class="timing-value"></div>
                        </div>
                        <div class="timing-row">
                            <div class="timing-label">H Active:</div>
                            <div id="hActiveInline" class="timing-value"></div>
                        </div>
                        <div class="timing-row">
                            <div class="timing-label">H Sync:</div>
                            <div id="hSyncInline" class="timing-value"></div>
                        </div>
                        <div class="timing-row">
                            <div class="timing-label">H Polarity:</div>
                            <div id="hPolarityInline" class="timing-value"></div>
                        </div>
                    </div>

                    <div class="card-divider"></div>

                    <!-- Vertical Timings -->
                    <div class="timing-section">
                        <div class="timing-title" style="font-size: 13px;">VERTICAL</div>
                        <div class="timing-row">
                            <div class="timing-label">V Total:</div>
                            <div id="vTotalInline" class="timing-value"></div>
                        </div>
                        <div class="timing-row">
                            <div class="timing-label">V Front Porch:</div>
                            <div id="vFrontPorchInline" class="timing-value"></div>
                        </div>
                        <div class="timing-row">
                            <div class="timing-label">V Active:</div>
                            <div id="vActiveInline" class="timing-value"></div>
                        </div>
                        <div class="timing-row">
                            <div class="timing-label">V Sync:</div>
                            <div id="vSyncInline" class="timing-value"></div>
                        </div>
                        <div class="timing-row">
                            <div class="timing-label">V Polarity:</div>
                            <div id="vPolarityInline" class="timing-value"></div>
                        </div>
                        <div class="timing-row">
                            <div class="timing-label">V Rate:</div>
                            <div id="vRateInline" class="timing-value"></div>
                        </div>
                    </div>

                </div>

                <!-- Export Buttons -->
                <div style="display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap;">
                    <button class="export-btn" style="margin-top: 0; flex: 1; min-width: 100px;" onclick="exportResults()">
                        <span>&#128247;</span>
                        IMAGE
                    </button>
                    <button class="export-btn" style="margin-top: 0; flex: 1; min-width: 100px; background: linear-gradient(90deg, rgb(180, 100, 60), rgb(200, 120, 80));" onclick="exportPPT()">
                        <span>&#128202;</span>
                        PPT
                    </button>
                </div>
            </div>
        </div>

        <!-- CSV Import/Export Buttons -->
        <div id="csvBtnContainer" class="csv-btn-container">
            <button class="csv-btn" onclick="exportSettingsCSV()">
                <span>&#128196;</span>
                EXPORT CSV
            </button>
            <button class="csv-btn" onclick="document.getElementById('csvFileInput').click()">
                <span>&#128229;</span>
                IMPORT CSV
            </button>
            <input type="file" id="csvFileInput" class="csv-file-input" accept=".csv" onchange="importSettingsCSV(event)">
        </div>

        <!-- Footer -->
        <div class="footer">
            By: Phillip Rude<br>
            Omniconpro.com<br>
            <span id="versionString">V1.12.0</span><br>
            UPDATED: 01/17/26
        </div>

        <div class="disclaimer">
            -DISCLAIMER-<br>
            The data represented in this app should be<br>
            used as a reference only and should be<br>
            independently verified before real world use.<br>
            Trust But Verify!
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="alertModal" class="modal-overlay" onclick="closeAlert(event)">
        <div class="alert-modal" onclick="event.stopPropagation()">
            <div id="alertTitle" class="alert-title"></div>
            <div id="alertMessage" class="alert-message"></div>
            <button class="alert-btn" onclick="closeAlert()">OK</button>
        </div>
    </div>

    <!-- EDID Timings Modal -->
    <div id="edidModal" class="modal-overlay" onclick="closeEDIDModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">EDID TIMINGS</div>
                <button class="modal-close" onclick="closeEDIDModal()">&times;</button>
            </div>
            <div id="edidSubtitle" class="modal-subtitle"></div>

            <div class="card" style="margin-bottom: 0;">
                <!-- Horizontal Timings -->
                <div class="timing-section">
                    <div class="timing-title">HORIZONTAL TIMINGS</div>
                    <div class="timing-row">
                        <div class="timing-label">H Total:</div>
                        <div id="hTotal" class="timing-value"></div>
                    </div>
                    <div class="timing-row">
                        <div class="timing-label">H Front Porch:</div>
                        <div id="hFrontPorch" class="timing-value"></div>
                    </div>
                    <div class="timing-row">
                        <div class="timing-label">H Active:</div>
                        <div id="hActive" class="timing-value"></div>
                    </div>
                    <div class="timing-row">
                        <div class="timing-label">H Sync:</div>
                        <div id="hSync" class="timing-value"></div>
                    </div>
                    <div class="timing-row">
                        <div class="timing-label">H Polarity:</div>
                        <div id="hPolarity" class="timing-value"></div>
                    </div>
                </div>

                <div class="card-divider"></div>

                <!-- Vertical Timings -->
                <div class="timing-section">
                    <div class="timing-title">VERTICAL TIMINGS</div>
                    <div class="timing-row">
                        <div class="timing-label">V Total:</div>
                        <div id="vTotal" class="timing-value"></div>
                    </div>
                    <div class="timing-row">
                        <div class="timing-label">V Front Porch:</div>
                        <div id="vFrontPorch" class="timing-value"></div>
                    </div>
                    <div class="timing-row">
                        <div class="timing-label">V Active:</div>
                        <div id="vActive" class="timing-value"></div>
                    </div>
                    <div class="timing-row">
                        <div class="timing-label">V Sync:</div>
                        <div id="vSync" class="timing-value"></div>
                    </div>
                    <div class="timing-row">
                        <div class="timing-label">V Polarity:</div>
                        <div id="vPolarity" class="timing-value"></div>
                    </div>
                    <div class="timing-row">
                        <div class="timing-label">V Rate:</div>
                        <div id="vRate" class="timing-value"></div>
                    </div>
                </div>

                <div class="card-divider"></div>

                <!-- Pixel Clock -->
                <div class="timing-section" style="margin-bottom: 0;">
                    <div class="timing-title">PIXEL CLOCK</div>
                    <div class="timing-row">
                        <div class="timing-label">Frequency:</div>
                        <div id="edidPixelClock" class="timing-value"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // STATE & CONSTANTS
        // ==========================================

        const connectorOptions = ["HDMI 2.0", "DP 1.2"];
        const computerOptions = ["MacBookPro", "MacStudio", "MacPro", "MacMini"];
        const processorOptions = [
            "M1", "M1 PRO", "M1 MAX", "M1 ULTRA",
            "M2", "M2 PRO", "M2 MAX", "M2 ULTRA",
            "M3", "M3 PRO", "M3 MAX", "M3 ULTRA",
            "M4", "M4 PRO", "M4 MAX",
            "M5"
        ];
        const macOSOptions = ["Monterey - 12", "Ventura - 13", "Sonoma - 14", "Sequoia - 15", "Tahoe - 26"];
        const capacityOptions = ["SL", "DL", "4K"];
        const reducedBlankingOptions = ["RB V1", "RB V2"];
        const frameRateOptions = ["23.98", "24", "25", "29.97", "30", "50", "59.94", "60"];
        const bitRateOptions = ["8 Bit", "10 Bit", "12 Bit"];

        // Computer -> Processor compatibility map
        const computerProcessorMap = {
            "MacBookPro": ["M1", "M1 PRO", "M1 MAX", "M2", "M2 PRO", "M2 MAX", "M3", "M3 PRO", "M3 MAX", "M4", "M4 PRO", "M4 MAX", "M5"],
            "MacStudio": ["M1 MAX", "M1 ULTRA", "M2 MAX", "M2 ULTRA", "M3 ULTRA", "M4 MAX"],
            "MacPro": ["M2 ULTRA"],
            "MacMini": ["M1", "M2", "M2 PRO", "M4", "M4 PRO"]
        };

        // Processor -> macOS compatibility (by processor prefix)
        const processorMacOSMap = {
            "M1": ["Monterey - 12", "Ventura - 13", "Sonoma - 14", "Sequoia - 15", "Tahoe - 26"],
            "M2": ["Ventura - 13", "Sonoma - 14", "Sequoia - 15", "Tahoe - 26"],
            "M3": ["Sonoma - 14", "Sequoia - 15", "Tahoe - 26"],
            "M4": ["Sequoia - 15", "Tahoe - 26"],
            "M5": ["Tahoe - 26"]
        };

        // Current state
        let state = {
            connector: "DP 1.2",
            computer: "",
            processor: "",
            macos: "",
            capacity: "4K",
            betterDisplay: false,
            dualDp: false,
            pixelDensityMode: false,
            frameRate: "59.94",
            bitRate: "8 Bit",
            chromaSubsampling: "4:4:4",
            reducedBlanking: "RB V2",
            edidTimings: null
        };

        // ==========================================
        // BIDIRECTIONAL FILTERING LOGIC
        // ==========================================

        function getProcessorPrefix(processor) {
            if (processor.startsWith("M1")) return "M1";
            if (processor.startsWith("M2")) return "M2";
            if (processor.startsWith("M3")) return "M3";
            if (processor.startsWith("M4")) return "M4";
            if (processor.startsWith("M5")) return "M5";
            return "";
        }

        function getValidComputers() {
            // If processor is selected, filter by processor
            if (state.processor) {
                return computerOptions.filter(computer =>
                    computerProcessorMap[computer].includes(state.processor)
                );
            }

            // If macOS is selected but no processor, filter to computers that have at least one processor supporting that macOS
            if (state.macos) {
                // Get processors that support this macOS
                const validProcessorsForMacOS = processorOptions.filter(proc => {
                    const prefix = getProcessorPrefix(proc);
                    return processorMacOSMap[prefix] && processorMacOSMap[prefix].includes(state.macos);
                });
                // Filter computers to those that have at least one of these processors
                return computerOptions.filter(computer => {
                    const computerProcessors = computerProcessorMap[computer];
                    return computerProcessors.some(proc => validProcessorsForMacOS.includes(proc));
                });
            }

            // No filters, all computers valid
            return computerOptions;
        }

        function getValidProcessors() {
            let validProcessors = [...processorOptions];

            // Filter by computer if selected
            if (state.computer) {
                validProcessors = validProcessors.filter(proc =>
                    computerProcessorMap[state.computer].includes(proc)
                );
            }

            // Filter by macOS if selected
            if (state.macos) {
                validProcessors = validProcessors.filter(proc => {
                    const prefix = getProcessorPrefix(proc);
                    return processorMacOSMap[prefix] && processorMacOSMap[prefix].includes(state.macos);
                });
            }

            return validProcessors;
        }

        function getValidMacOS() {
            // If no processor selected, all macOS are valid
            if (!state.processor) return macOSOptions;

            const prefix = getProcessorPrefix(state.processor);
            return processorMacOSMap[prefix] || macOSOptions;
        }

        function getValidCapacities() {
            // All capacities are always valid
            return capacityOptions;
        }

        function updateAllDropdowns() {
            const validComputers = getValidComputers();
            const validProcessors = getValidProcessors();
            const validMacOS = getValidMacOS();
            const validCapacities = getValidCapacities();

            // Update Computer dropdown
            const computerSelect = document.getElementById('computer');
            Array.from(computerSelect.options).forEach(option => {
                if (option.value === "") return; // Skip placeholder
                option.disabled = !validComputers.includes(option.value);
            });

            // Update Processor dropdown
            const processorSelect = document.getElementById('processor');
            // Clear and rebuild processor options
            processorSelect.innerHTML = '<option value="">-- Select --</option>';
            processorOptions.forEach(proc => {
                const opt = document.createElement('option');
                opt.value = proc;
                opt.textContent = proc;
                opt.disabled = !validProcessors.includes(proc);
                if (proc === state.processor) opt.selected = true;
                processorSelect.appendChild(opt);
            });

            // Update macOS dropdown
            const macosSelect = document.getElementById('macos');
            macosSelect.innerHTML = '<option value="">-- Select --</option>';
            macOSOptions.forEach(os => {
                const opt = document.createElement('option');
                opt.value = os;
                opt.textContent = os;
                opt.disabled = !validMacOS.includes(os);
                if (os === state.macos) opt.selected = true;
                macosSelect.appendChild(opt);
            });

            // Update Capacity dropdown
            const capacitySelect = document.getElementById('capacity');
            Array.from(capacitySelect.options).forEach(option => {
                if (option.value === "") return; // Skip placeholder
                option.disabled = !validCapacities.includes(option.value);
            });

            // Update Better Display state
            updateBetterDisplayState();
        }

        function getMaxSupportedDisplays() {
            switch (state.computer) {
                case "MacBookPro":
                    switch (state.processor) {
                        case "M1": return "1";
                        case "M1 PRO": return "2";
                        case "M1 MAX": return "4";
                        case "M2": return "1";
                        case "M2 PRO": return "2";
                        case "M2 MAX": return "4";
                        case "M3": return "2";
                        case "M3 PRO": return "2";
                        case "M3 MAX": return "4";
                        case "M4": return "2";
                        case "M4 PRO": return "2";
                        case "M4 MAX": return "4";
                        case "M5": return "2";
                        default: return "N/A";
                    }
                case "MacPro":
                    if (state.processor === "M2 ULTRA") {
                        return "6 (Local +5)";
                    }
                    return "N/A";
                case "MacStudio":
                    switch (state.processor) {
                        case "M1 MAX": return "5 (Local +4)";
                        case "M1 ULTRA": return "5 (Local +4)";
                        case "M2 MAX": return "5 (Local +4)";
                        case "M2 ULTRA": return "8 (Local +7)";
                        case "M3 ULTRA": return "8 (Local +7)";
                        case "M4 MAX": return "5 (Local +4)";
                        default: return "N/A";
                    }
                case "MacMini":
                    switch (state.processor) {
                        case "M1": return "2 (Local +1)";
                        case "M2": return "2 (Local +1)";
                        case "M2 PRO": return "3 (Local +2)";
                        case "M4": return "3 (Local +2)";
                        case "M4 PRO": return "3 (Local +2)";
                        default: return "N/A";
                    }
                default:
                    return "N/A";
            }
        }

        // ==========================================
        // CALCULATIONS
        // ==========================================

        function getBandwidthMultiplier() {
            let bitsPerComponent;
            switch (state.bitRate) {
                case "8 Bit": bitsPerComponent = 8; break;
                case "10 Bit": bitsPerComponent = 10; break;
                case "12 Bit": bitsPerComponent = 12; break;
                default: bitsPerComponent = 8;
            }

            if (state.connector.startsWith("DP")) {
                return 1.0;
            } else {
                // HDMI TMDS calculations
                let dc;
                switch (state.bitRate) {
                    case "8 Bit": dc = 1.0; break;
                    case "10 Bit": dc = 1.25; break;
                    case "12 Bit": dc = 1.5; break;
                    default: dc = 1.0;
                }
                return dc;
            }
        }

        function computeMaxPixelClock() {
            let baseClock;

            switch (state.connector) {
                case "DP 1.2":
                    // Base 4K value is fixed at 660 MHz
                    let base4K = 660;

                    // Apply capacity multiplier: 4K=100%, DL=50%, SL=25%
                    let capacityMultiplier;
                    switch (state.capacity) {
                        case "SL": capacityMultiplier = 0.25; break;
                        case "DL": capacityMultiplier = 0.50; break;
                        default: capacityMultiplier = 1.0; // 4K or no selection
                    }

                    baseClock = Math.floor(base4K * capacityMultiplier);

                    // Double for Dual DP mode
                    if (state.dualDp) {
                        baseClock *= 2;
                    }
                    break;
                case "HDMI 2.0":
                    // HDMI 2.0: 600 MHz TMDS clock limit at 4K
                    let baseHDMI = 600;

                    // Apply capacity multiplier: 4K=100%, DL=50%, SL=25%
                    let hdmiCapacityMultiplier;
                    switch (state.capacity) {
                        case "SL": hdmiCapacityMultiplier = 0.25; break;
                        case "DL": hdmiCapacityMultiplier = 0.50; break;
                        default: hdmiCapacityMultiplier = 1.0; // 4K or no selection
                    }

                    baseClock = Math.floor(baseHDMI * hdmiCapacityMultiplier);
                    break;
                default:
                    baseClock = 0;
            }

            return baseClock;
        }

        function computePixelClock(width, height, frameRate, blanking) {
            // For HDMI, use CTA-861 standard timings when available
            const exact59_94 = 60000.0 / 1001.0;
            if (state.connector.startsWith("HDMI") && Math.abs(frameRate - exact59_94) < 0.0001) {
                if (width === 1920 && height === 1080) return 148.5 * 1000.0 / 1001.0;
                if (width === 3840 && height === 2160) return 594.0 * 1000.0 / 1001.0;
                if (width === 1280 && height === 720) return 74.25 * 1000.0 / 1001.0;
                if (width === 2560 && height === 1440) return 241.5;
            }

            if (blanking === "RB V2") {
                // CVT-RB v2: Fixed blanking of 80px horizontal, 30 lines vertical
                const hTotal = width + 80.0;
                const vTotal = height + 30.0;
                const pixelClockMHz = hTotal * vTotal * frameRate / 1000000.0;
                return Math.round(pixelClockMHz * 1000.0) / 1000.0;
            } else {
                // CVT-RB v1: Use traditional CVT calculation with 460μs VBI
                const hActive = width;
                const vActive = height;
                const refresh = frameRate;

                const tVBI = 460.0;
                const hPeriodEstimate = (1000000.0 / refresh - tVBI) / vActive;
                const vBlankLines = Math.ceil(tVBI / hPeriodEstimate);
                const totalLines = vActive + vBlankLines;
                const hBlankClocks = 160.0;
                const totalPixelsPerLine = hActive + hBlankClocks;

                let pixelClockMHz = totalPixelsPerLine * totalLines * refresh / 1000000.0;
                pixelClockMHz = Math.round(pixelClockMHz * 4.0) / 4.0;

                return pixelClockMHz;
            }
        }

        function getDefaultMaxRes(processor, macOS, betterDisplay) {
            if (!processor) return 6144;
            if (processor.startsWith("M1")) {
                return (macOS && macOS.startsWith("Monterey")) ? 8192 : 6144;
            } else if (processor.startsWith("M2") || processor.startsWith("M3") ||
                       processor.startsWith("M4") || processor.startsWith("M5")) {
                return betterDisplay ? 7680 : 6144;
            }
            return 6144;
        }

        function computeLimits() {
            let allowedMax = 0;
            let allowedPixels = Number.MAX_SAFE_INTEGER;

            if (state.capacity === "SL") {
                allowedMax = 2048;
            } else if (state.capacity === "DL") {
                allowedMax = 4096;
            } else if (state.capacity === "4K") {
                if (state.connector === "DP 1.2" && state.dualDp) {
                    allowedMax = 6144;
                } else if (state.connector !== "DP 1.2") {
                    allowedMax = 4096;
                } else {
                    allowedMax = getDefaultMaxRes(state.processor, state.macos, state.betterDisplay);
                }
            } else {
                allowedMax = getDefaultMaxRes(state.processor, state.macos, state.betterDisplay);
            }

            if (allowedMax <= 0) {
                allowedMax = 4096;
            }

            return { maxInput: allowedMax, allowedPixels: allowedPixels };
        }

        function calculateEDIDTimings(width, height, frameRate, blanking) {
            const hActive = width;
            const vActive = height;

            if (blanking === "RB V2") {
                const hBlank = 80;
                const hTotal = hActive + hBlank;
                const vBlank = 30;
                const vTotal = vActive + vBlank;

                const hFrontPorch = 8;
                const hSyncWidth = 32;
                const vSyncWidth = 8;
                const vBackPorch = 6;
                const vFrontPorch = vBlank - vSyncWidth - vBackPorch;

                const pixelClockMHz = hTotal * vTotal * frameRate / 1000000.0;
                const roundedPixelClockMHz = Math.round(pixelClockMHz * 1000.0) / 1000.0;

                const hFreq = roundedPixelClockMHz * 1000000.0 / hTotal / 1000.0;
                const vFreq = frameRate;

                return {
                    hActive: hActive,
                    hBlank: hBlank,
                    hSyncOffset: hFrontPorch,
                    hSyncWidth: hSyncWidth,
                    vActive: vActive,
                    vBlank: vBlank,
                    vSyncOffset: vFrontPorch,
                    vSyncWidth: vSyncWidth,
                    pixelClock: roundedPixelClockMHz,
                    hTotal: hTotal,
                    vTotal: vTotal,
                    hFreq: hFreq,
                    vFreq: vFreq,
                    hPolarity: "(+)",
                    vPolarity: "(-)"
                };
            } else {
                const hBlank = 160;
                const hTotal = hActive + hBlank;

                const tVBI = 460.0;
                const hPeriodEstimate = (1000000.0 / frameRate - tVBI) / vActive;
                const vBlankLines = Math.ceil(tVBI / hPeriodEstimate);
                const vTotal = vActive + vBlankLines;
                const vBlank = vBlankLines;

                const hSyncOffset = 48;
                const hSyncWidth = 32;
                const vSyncWidth = 10;
                const vFrontPorch = 3;

                const pixelClockHz = hTotal * vTotal * frameRate;
                const pixelClockMHz = Math.round(pixelClockHz / 1000000.0 * 4.0) / 4.0;

                const hFreq = pixelClockMHz * 1000000.0 / hTotal / 1000.0;
                const vFreq = frameRate;

                return {
                    hActive: hActive,
                    hBlank: hBlank,
                    hSyncOffset: hSyncOffset,
                    hSyncWidth: hSyncWidth,
                    vActive: vActive,
                    vBlank: vBlank,
                    vSyncOffset: vFrontPorch,
                    vSyncWidth: vSyncWidth,
                    pixelClock: pixelClockMHz,
                    hTotal: hTotal,
                    vTotal: vTotal,
                    hFreq: hFreq,
                    vFreq: vFreq,
                    hPolarity: "(+)",
                    vPolarity: "(-)"
                };
            }
        }

        function decimalAspectRatio(width, height) {
            if (width <= 0 || height <= 0) return "-";

            if (width >= height) {
                const ratio = width / height;
                return ratio.toFixed(2) + ":1";
            } else {
                const ratio = height / width;
                return "1:" + ratio.toFixed(2);
            }
        }

        // ==========================================
        // MAIN CALCULATE FUNCTION
        // ==========================================

        function calculate() {
            blinkScreen();
            clearResults();

            const widthInput = document.getElementById('displayWidth').value.trim();
            const heightInput = document.getElementById('displayHeight').value.trim();

            const origW = parseInt(widthInput);
            const origH = parseInt(heightInput);

            if (isNaN(origW) || isNaN(origH) || origW <= 0 || origH <= 0) {
                showResults("Invalid input", "", "", "", "", "", null);
                return;
            }

            const { maxInput, allowedPixels } = computeLimits();

            // 1) candidateW is whichever is smaller: origW or maxInput, aligned to 8
            let candidateW = Math.min(origW, maxInput);
            candidateW -= (candidateW % 8);

            // 2) keep aspect ratio
            let candidateH = Math.floor((candidateW * origH) / origW);

            // 3) scale down to meet pixel count and pixel clock limits
            const maxLimit = computeMaxPixelClock();

            while (candidateW > 0 && candidateW * candidateH > allowedPixels) {
                candidateW -= 8;
                candidateH = Math.floor((candidateW * origH) / origW);
            }

            // Check pixel clock/bandwidth limit
            const frameRate = parseFloat(document.getElementById('frameRate').value);
            const blanking = document.getElementById('reducedBlanking').value;

            while (candidateW > 0) {
                const pixelClock = computePixelClock(candidateW, candidateH, frameRate, blanking);

                let exceedsLimit = false;

                // Chroma subsampling multiplier: 4:4:4 = 1.0, 4:2:2 = 2/3
                const chromaMultiplier = state.chromaSubsampling === "4:2:2" ? (2/3) : 1.0;

                if (state.connector.startsWith("DP")) {
                    // For DP, scale pixel clock by bit depth ratio (relative to 8-bit baseline)
                    let dpBitMultiplier;
                    switch (state.bitRate) {
                        case "8 Bit": dpBitMultiplier = 1.0; break;
                        case "10 Bit": dpBitMultiplier = 10 / 8; break;  // 1.25
                        case "12 Bit": dpBitMultiplier = 12 / 8; break;  // 1.5
                        default: dpBitMultiplier = 1.0;
                    }
                    exceedsLimit = (pixelClock * dpBitMultiplier * chromaMultiplier) > maxLimit;
                } else {
                    const tmdsClk = pixelClock * getBandwidthMultiplier() * chromaMultiplier;
                    exceedsLimit = tmdsClk > maxLimit;
                }

                if (!exceedsLimit) {
                    break;
                }

                candidateW -= 8;
                candidateH = Math.floor((candidateW * origH) / origW);
            }

            // Enforce pixel density max vertical constraint if enabled
            if (state.pixelDensityMode) {
                const maxV = parseInt(document.getElementById('maxVertical').value);
                if (!isNaN(maxV) && maxV > 0) {
                    const upper = maxV + 20;
                    const alignedUpperV = upper - (upper % 8);
                    const lower = maxV - 20;
                    const alignedLowerV = lower + ((8 - (lower % 8)) % 8);

                    function resolution(targetH) {
                        let w = Math.floor((targetH * origW) / origH);
                        w -= (w % 8);
                        const h = Math.floor((w * origH) / origW);
                        return { w: w, h: h };
                    }

                    let best = resolution(alignedLowerV);
                    let smallestDiff = Math.abs(best.h - maxV);

                    for (let h = alignedLowerV; h <= alignedUpperV; h += 8) {
                        const cand = resolution(h);
                        const diff = Math.abs(cand.h - maxV);
                        if (diff < smallestDiff) {
                            best = cand;
                            smallestDiff = diff;
                        }
                    }

                    candidateW = best.w;
                    candidateH = best.h;
                }
            }

            if (candidateW <= 0) {
                showResults("Error", "", "", "", "", "", null);
                return;
            }

            // Check if no scaling is needed
            let newResolution;
            let edidTimings;
            const fr = frameRate;

            if (candidateW === origW && candidateH === origH) {
                newResolution = "No Scaling Needed";
                if (state.dualDp) {
                    edidTimings = calculateEDIDTimings(Math.floor(origW / 2), origH, fr, blanking);
                } else {
                    edidTimings = calculateEDIDTimings(origW, origH, fr, blanking);
                }
            } else {
                newResolution = `${candidateW} x ${candidateH}`;
                if (state.dualDp) {
                    edidTimings = calculateEDIDTimings(Math.floor(candidateW / 2), candidateH, fr, blanking);
                } else {
                    edidTimings = calculateEDIDTimings(candidateW, candidateH, fr, blanking);
                }
            }

            state.edidTimings = edidTimings;

            // Aspect ratios
            const originalAspect = decimalAspectRatio(origW, origH);
            const scaledAspect = decimalAspectRatio(candidateW, candidateH);

            // Keynote Canvas Calculation
            const srW = candidateW;
            const srH = candidateH;
            const keynoteScale = Math.min(1.0, 8192.0 / srW, 8192.0 / srH);
            const keynoteW = Math.floor(srW * keynoteScale);
            const keynoteH = Math.floor(srH * keynoteScale);
            const keynoteResult = `${keynoteW} x ${keynoteH}`;

            // PPT Canvas Calculation
            const pptScale = Math.min(1.0, 4032.0 / srW, 4032.0 / srH);
            const pptW = Math.floor(srW * pptScale);
            const pptH = Math.floor(srH * pptScale);
            const pptWidthInches = pptW / 72.0;
            const pptHeightInches = pptH / 72.0;
            const pptResult = `${pptWidthInches.toFixed(2)} x ${pptHeightInches.toFixed(2)}in`;

            // Calculate pixel/TMDS clock for display
            const pcMHz = computePixelClock(candidateW, candidateH, fr, blanking);
            let displayClock;

            // Chroma subsampling multiplier: 4:4:4 = 1.0, 4:2:2 = 2/3
            const chromaMultiplier = state.chromaSubsampling === "4:2:2" ? (2/3) : 1.0;

            if (state.connector.startsWith("DP")) {
                // For DP, apply bit depth multiplier to show effective bandwidth usage
                let dpBitMultiplier;
                switch (state.bitRate) {
                    case "8 Bit": dpBitMultiplier = 1.0; break;
                    case "10 Bit": dpBitMultiplier = 10 / 8; break;  // 1.25
                    case "12 Bit": dpBitMultiplier = 12 / 8; break;  // 1.5
                    default: dpBitMultiplier = 1.0;
                }
                displayClock = pcMHz * dpBitMultiplier * chromaMultiplier;
            } else {
                displayClock = pcMHz * getBandwidthMultiplier() * chromaMultiplier;
            }
            const scaledPixelClock = displayClock.toFixed(2) + " MHz";

            showResults(newResolution, scaledPixelClock, originalAspect, scaledAspect, keynoteResult, pptResult, edidTimings);

            // Scroll to results
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function showResults(resolution, pixelClock, origAspect, scaledAspect, keynote, ppt, timings) {
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.classList.remove('hidden');

            const scaledResEl = document.getElementById('scaledResolution');
            scaledResEl.textContent = resolution;

            if (resolution === "No Scaling Needed") {
                scaledResEl.classList.add('result-value-success');
            } else {
                scaledResEl.classList.remove('result-value-success');
            }

            // Show original resolution
            const origW = document.getElementById('displayWidth').value.trim();
            const origH = document.getElementById('displayHeight').value.trim();
            document.getElementById('originalResolution').textContent = `${origW} x ${origH}`;

            document.getElementById('pixelClockResult').textContent = pixelClock;
            document.getElementById('originalAspect').textContent = origAspect;
            document.getElementById('scaledAspect').textContent = scaledAspect;
            document.getElementById('keynoteCanvas').textContent = keynote;
            document.getElementById('pptCanvas').textContent = ppt;

            // Update clock label based on connector
            const clockLabel = document.getElementById('clockLabel');
            clockLabel.textContent = state.connector.startsWith("HDMI") ? "TMDS Clock:" : "Pixel Clock:";

            // Handle resolution per cable for Dual DP
            const perCableRow = document.getElementById('resolutionPerCableRow');
            const perCableValue = document.getElementById('resolutionPerCable');

            if (state.dualDp && resolution !== "Invalid input" && resolution !== "Error") {
                const pcNum = parseFloat(pixelClock.replace(" MHz", ""));
                if (resolution !== "No Scaling Needed" || pcNum > 660) {
                    perCableRow.classList.remove('hidden');

                    let w, h;
                    if (resolution === "No Scaling Needed") {
                        w = parseInt(document.getElementById('displayWidth').value);
                        h = parseInt(document.getElementById('displayHeight').value);
                    } else {
                        const parts = resolution.split(" x ");
                        w = parseInt(parts[0]);
                        h = parseInt(parts[1]);
                    }
                    perCableValue.textContent = `${Math.floor(w/2)} x ${h}`;
                } else {
                    perCableRow.classList.add('hidden');
                }
            } else {
                perCableRow.classList.add('hidden');
            }

            // Show/populate inline EDID timings
            const edidInline = document.getElementById('edidTimingsInline');
            if (timings) {
                edidInline.classList.remove('hidden');

                // Get display resolution for subtitle
                const frameRate = document.getElementById('frameRate').value;
                const bitRate = document.getElementById('bitRate').value;
                const chromaSub = document.getElementById('chromaSubsampling').value;
                let displayRes;
                if (resolution === "No Scaling Needed") {
                    const w = document.getElementById('displayWidth').value.trim();
                    const h = document.getElementById('displayHeight').value.trim();
                    displayRes = `${w} x ${h}`;
                } else {
                    displayRes = resolution;
                }
                document.getElementById('edidSubtitleInline').textContent = `${displayRes} @ ${frameRate}Hz - ${bitRate} ${chromaSub}`;
                document.getElementById('edidCapacityInline').textContent = `E2 Connector Capacity: ${state.capacity}`;

                // Populate timing values
                document.getElementById('hTotalInline').textContent = timings.hTotal;
                document.getElementById('hFrontPorchInline').textContent = timings.hSyncOffset;
                document.getElementById('hActiveInline').textContent = timings.hActive;
                document.getElementById('hSyncInline').textContent = timings.hSyncWidth;
                document.getElementById('hPolarityInline').textContent = timings.hPolarity;

                document.getElementById('vTotalInline').textContent = timings.vTotal;
                document.getElementById('vFrontPorchInline').textContent = timings.vSyncOffset;
                document.getElementById('vActiveInline').textContent = timings.vActive;
                document.getElementById('vSyncInline').textContent = timings.vSyncWidth;
                document.getElementById('vPolarityInline').textContent = timings.vPolarity;
                document.getElementById('vRateInline').textContent = timings.vFreq.toFixed(2) + " Hz";
            } else {
                edidInline.classList.add('hidden');
            }
        }

        function clearResults() {
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.classList.add('hidden');
            state.edidTimings = null;
        }

        // ==========================================
        // UI UPDATE FUNCTIONS
        // ==========================================

        function updateLimits() {
            const { maxInput } = computeLimits();
            document.getElementById('maxHorizontal').textContent = maxInput;

            const pc = computeMaxPixelClock();
            document.getElementById('maxPixelClock').textContent = `${pc} MHz`;

            document.getElementById('maxDisplays').textContent = getMaxSupportedDisplays();
        }

        function updateBetterDisplayState() {
            const betterDisplayCheckbox = document.getElementById('betterDisplay');
            const warningEl = document.getElementById('betterDisplayWarning');

            if (state.processor && state.processor.startsWith("M1")) {
                betterDisplayCheckbox.disabled = true;
                betterDisplayCheckbox.checked = false;
                state.betterDisplay = false;
                warningEl.classList.remove('hidden');
            } else {
                betterDisplayCheckbox.disabled = false;
                warningEl.classList.add('hidden');
            }
        }

        function updateDualDpState() {
            const dualDpCheckbox = document.getElementById('dualDp');
            if (state.connector !== "DP 1.2") {
                dualDpCheckbox.disabled = true;
                dualDpCheckbox.checked = false;
                state.dualDp = false;
            } else {
                dualDpCheckbox.disabled = false;
            }
        }

        // ==========================================
        // EVENT HANDLERS
        // ==========================================

        function onConnectorChange() {
            state.connector = document.getElementById('connector').value;
            if (state.connector !== "DP 1.2") {
                state.dualDp = false;
                document.getElementById('dualDp').checked = false;
            }
            updateDualDpState();
            clearResults();
            updateLimits();
        }

        function onComputerChange() {
            state.computer = document.getElementById('computer').value;
            // Clear processor if it's no longer valid
            if (state.processor && state.computer) {
                const validProcessors = computerProcessorMap[state.computer];
                if (!validProcessors.includes(state.processor)) {
                    state.processor = "";
                    state.macos = ""; // Also clear macOS if processor was cleared
                }
            }
            updateAllDropdowns();
            clearResults();
            updateLimits();
        }

        function onProcessorChange() {
            state.processor = document.getElementById('processor').value;
            // Clear computer if it's no longer valid
            if (state.processor && state.computer) {
                const validComputers = getValidComputers();
                if (!validComputers.includes(state.computer)) {
                    state.computer = "";
                    document.getElementById('computer').value = "";
                }
            }
            // Clear macOS if it's no longer valid
            if (state.processor && state.macos) {
                const validMacOS = getValidMacOS();
                if (!validMacOS.includes(state.macos)) {
                    state.macos = "";
                }
            }
            updateAllDropdowns();
            clearResults();
            updateLimits();
        }

        function onMacOSChange() {
            state.macos = document.getElementById('macos').value;
            // Clear processor if it's no longer valid with selected macOS
            if (state.macos && state.processor) {
                const validProcessors = getValidProcessors();
                if (!validProcessors.includes(state.processor)) {
                    state.processor = "";
                }
            }
            // Check if computer is still valid (even if no processor selected)
            if (state.macos && state.computer) {
                const validComputers = getValidComputers();
                if (!validComputers.includes(state.computer)) {
                    state.computer = "";
                    document.getElementById('computer').value = "";
                }
            }
            updateAllDropdowns();
            clearResults();
            updateLimits();
        }

        function onCapacityChange() {
            state.capacity = document.getElementById('capacity').value;
            clearResults();
            updateLimits();
        }

        function onBetterDisplayChange() {
            state.betterDisplay = document.getElementById('betterDisplay').checked;
            if (state.betterDisplay) {
                state.dualDp = false;
                document.getElementById('dualDp').checked = false;
            }
            clearResults();
            updateLimits();
        }

        function onDualDpChange() {
            state.dualDp = document.getElementById('dualDp').checked;
            if (state.dualDp) {
                state.betterDisplay = false;
                document.getElementById('betterDisplay').checked = false;
            }
            clearResults();
            updateLimits();
        }

        function onBitRateChange() {
            state.bitRate = document.getElementById('bitRate').value;
            clearResults();
            updateLimits();
        }

        function onChromaChange() {
            state.chromaSubsampling = document.getElementById('chromaSubsampling').value;
            clearResults();
        }

        function onPixelDensityModeChange() {
            state.pixelDensityMode = document.getElementById('pixelDensityMode').checked;
            const maxVerticalInput = document.getElementById('maxVertical');

            if (state.pixelDensityMode) {
                maxVerticalInput.classList.remove('hidden');
            } else {
                maxVerticalInput.classList.add('hidden');
                maxVerticalInput.value = '';
            }
            clearResults();
        }

        function resetSystemConfig() {
            // Reset state
            state.computer = "";
            state.processor = "";
            state.macos = "";
            state.capacity = "4K";
            state.betterDisplay = false;

            // Reset UI elements
            document.getElementById('computer').value = "";
            document.getElementById('capacity').value = "4K";
            document.getElementById('betterDisplay').checked = false;

            // Update all dropdowns (this will rebuild processor and macos dropdowns)
            updateAllDropdowns();
            clearResults();
            updateLimits();
        }

        // ==========================================
        // EXPORT RESULTS
        // ==========================================

        function exportPPT() {
            const originalRes = document.getElementById('originalResolution').textContent;
            const scaledRes = document.getElementById('scaledResolution').textContent;
            const pptCanvas = document.getElementById('pptCanvas').textContent;

            // Parse PPT canvas dimensions (e.g., "53.33 x 30.00in")
            const pptMatch = pptCanvas.match(/([\d.]+)\s*x\s*([\d.]+)/);
            if (!pptMatch) {
                showAlert('Export Failed', 'Unable to parse PPT Canvas dimensions.');
                return;
            }
            const pptWidth = parseFloat(pptMatch[1]);
            const pptHeight = parseFloat(pptMatch[2]);

            // Create presentation with custom slide size
            const pptx = new PptxGenJS();
            pptx.defineLayout({ name: 'CUSTOM', width: pptWidth, height: pptHeight });
            pptx.layout = 'CUSTOM';

            // Add a slide
            const slide = pptx.addSlide();

            // Set dark background
            slide.background = { color: '1E325A' };

            // Scale font sizes based on slide height
            const fontScale = pptHeight / 7.5;  // Base scale for standard slide

            // Add title
            slide.addText('PPT CANVAS', {
                x: 0,
                y: pptHeight * 0.15,
                w: '100%',
                h: pptHeight * 0.12,
                fontSize: Math.round(60 * fontScale),
                fontFace: 'Arial',
                color: 'FFFFFF',
                bold: true,
                align: 'center',
                valign: 'middle'
            });

            // Add Display (Original Resolution)
            slide.addText(`Display: ${originalRes}`, {
                x: 0,
                y: pptHeight * 0.32,
                w: '100%',
                h: pptHeight * 0.08,
                fontSize: Math.round(32 * fontScale),
                fontFace: 'Arial',
                color: 'AAAAAA',
                align: 'center',
                valign: 'middle'
            });

            // Add Scaled Resolution (use original if no scaling needed)
            const displayResolution = scaledRes === "No Scaling Needed" ? originalRes : scaledRes;
            slide.addText(`Resolution: ${displayResolution}`, {
                x: 0,
                y: pptHeight * 0.45,
                w: '100%',
                h: pptHeight * 0.1,
                fontSize: Math.round(44 * fontScale),
                fontFace: 'Arial',
                color: '4ADE80',
                bold: true,
                align: 'center',
                valign: 'middle'
            });

            // Add PPT Canvas size
            slide.addText(`PPT Canvas: ${pptCanvas}`, {
                x: 0,
                y: pptHeight * 0.58,
                w: '100%',
                h: pptHeight * 0.08,
                fontSize: Math.round(32 * fontScale),
                fontFace: 'Arial',
                color: 'AAAAAA',
                align: 'center',
                valign: 'middle'
            });

            // Add footer
            slide.addText('Generated by OmniCalc - omniconpro.com', {
                x: 0,
                y: pptHeight * 0.88,
                w: '100%',
                h: pptHeight * 0.06,
                fontSize: Math.round(16 * fontScale),
                fontFace: 'Arial',
                color: '666666',
                align: 'center',
                valign: 'middle'
            });

            // Generate filename
            const dateStr = new Date().toISOString().slice(0, 10);
            const filename = `PPT_Canvas_${scaledRes.replace(/ /g, '')}_${dateStr}.pptx`;

            // Detect if mobile device
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

            // Always use blob method for more reliable cross-browser downloads
            pptx.write('blob').then(blob => {
                if (isMobile && navigator.share && navigator.canShare) {
                    // Mobile: Use Web Share API
                    const file = new File([blob], filename, { type: 'application/vnd.openxmlformats-officedocument.presentationml.presentation' });
                    if (navigator.canShare({ files: [file] })) {
                        navigator.share({
                            files: [file],
                            title: 'PPT Canvas',
                            text: 'OmniCalc PPT Canvas Export'
                        }).catch(err => {
                            // User cancelled or share failed, fallback to download
                            downloadFile(blob, filename);
                        });
                    } else {
                        downloadFile(blob, filename);
                    }
                } else {
                    // Desktop: Use blob download (more reliable than writeFile)
                    downloadFile(blob, filename);
                }
            }).catch(err => {
                console.error('PPT export error:', err);
                showAlert('Export Failed', 'Unable to generate PPT file. Please try again.');
            });
        }

        function exportResults() {
            const resultsCard = document.querySelector('.card-results');
            const exportBtns = document.querySelectorAll('.export-btn');
            const exportBtnContainer = exportBtns[0]?.parentElement;

            // Hide all export buttons temporarily
            if (exportBtnContainer) {
                exportBtnContainer.style.display = 'none';
            }

            // Add padding for the screenshot
            const originalPadding = resultsCard.style.padding;
            resultsCard.style.padding = '20px';

            html2canvas(resultsCard, {
                backgroundColor: 'rgb(30, 50, 90)',
                scale: 2, // Higher resolution
                logging: false,
                useCORS: true
            }).then(canvas => {
                // Restore the export buttons
                if (exportBtnContainer) {
                    exportBtnContainer.style.display = 'flex';
                }
                resultsCard.style.padding = originalPadding;

                const scaledRes = document.getElementById('scaledResolution').textContent;
                const timestamp = new Date().toISOString().slice(0, 10);
                const filename = `EDID_Results_${scaledRes.replace(/ /g, '')}_${timestamp}.jpg`;

                // Detect if mobile device
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

                const imageData = canvas.toDataURL('image/jpeg', 0.95);

                if (isMobile || isInIframe()) {
                    // Mobile or iframe: show modal with image for right-click/long-press saving
                    showExportModal(imageData, isIOS);
                } else {
                    // Standard desktop download (not in iframe)
                    const link = document.createElement('a');
                    link.download = filename;
                    link.href = imageData;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    setTimeout(() => {
                        document.body.removeChild(link);
                    }, 500);
                }
            }).catch(err => {
                // Restore the export buttons on error
                if (exportBtnContainer) {
                    exportBtnContainer.style.display = 'flex';
                }
                resultsCard.style.padding = originalPadding;
                console.error('Export failed:', err);
                showAlert('Export Failed', 'Unable to export results. Please try again.');
            });
        }

        function exportSettingsCSV() {
            const timestamp = new Date().toISOString();
            const version = document.getElementById('versionString').textContent;
            const hasResults = !document.getElementById('resultsSection').classList.contains('hidden');

            // Gather all settings
            const settings = {
                // App Info
                'App Version': version,
                'Export Timestamp': timestamp,

                // System Configuration
                'Connector': state.connector,
                'Computer Model': state.computer || 'Not Selected',
                'M-Series Chip': state.processor || 'Not Selected',
                'macOS': state.macos || 'Not Selected',
                'Connector Capacity': state.capacity,
                'Better Display': state.betterDisplay ? 'On' : 'Off',

                // Resolution Calculator Settings
                'Display Width Input': document.getElementById('displayWidth').value || '',
                'Display Height Input': document.getElementById('displayHeight').value || '',
                'Frame Rate': document.getElementById('frameRate').value,
                'Bit Rate': state.bitRate,
                'Chroma Subsampling': state.chromaSubsampling,
                'Reduced Blanking': document.getElementById('reducedBlanking').value,
                'Dual DP 1.2': state.dualDp ? 'On' : 'Off',
                'Pixel Density Mode': state.pixelDensityMode ? 'On' : 'Off',
                'Max Vertical': document.getElementById('maxVertical').value || 'N/A',

                // Configuration Limits
                'Max Horizontal Limit': document.getElementById('maxHorizontal').textContent,
                'Max Pixel Clock Limit': document.getElementById('maxPixelClock').textContent,
                'Max Displays': document.getElementById('maxDisplays').textContent
            };

            // Add results only if calculation has been run
            if (hasResults) {
                settings['Scaled Resolution'] = document.getElementById('scaledResolution').textContent || '';
                settings['Original Resolution'] = document.getElementById('originalResolution').textContent || '';
                settings['Pixel Clock Result'] = document.getElementById('pixelClockResult').textContent || '';
                settings['Original Aspect'] = document.getElementById('originalAspect').textContent || '';
                settings['Scaled Aspect'] = document.getElementById('scaledAspect').textContent || '';
                settings['Keynote Canvas'] = document.getElementById('keynoteCanvas').textContent || '';
                settings['PPT Canvas'] = document.getElementById('pptCanvas').textContent || '';
            }

            // Add EDID timings if available
            if (hasResults && state.edidTimings) {
                settings['EDID H Total'] = state.edidTimings.hTotal;
                settings['EDID H Front Porch'] = state.edidTimings.hSyncOffset;
                settings['EDID H Active'] = state.edidTimings.hActive;
                settings['EDID H Sync'] = state.edidTimings.hSyncWidth;
                settings['EDID H Polarity'] = state.edidTimings.hPolarity;
                settings['EDID V Total'] = state.edidTimings.vTotal;
                settings['EDID V Front Porch'] = state.edidTimings.vSyncOffset;
                settings['EDID V Active'] = state.edidTimings.vActive;
                settings['EDID V Sync'] = state.edidTimings.vSyncWidth;
                settings['EDID V Polarity'] = state.edidTimings.vPolarity;
                settings['EDID V Rate'] = state.edidTimings.vFreq.toFixed(2) + ' Hz';
                settings['EDID Pixel Clock'] = state.edidTimings.pixelClock.toFixed(2) + ' MHz';
            }

            // Build CSV content
            let csvContent = 'Setting,Value\n';
            for (const [key, value] of Object.entries(settings)) {
                // Escape values that contain commas or quotes
                let escapedValue = String(value).replace(/"/g, '""');
                if (escapedValue.includes(',') || escapedValue.includes('"') || escapedValue.includes('\n')) {
                    escapedValue = `"${escapedValue}"`;
                }
                csvContent += `${key},${escapedValue}\n`;
            }

            // Create blob and filename
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const dateStr = new Date().toISOString().slice(0, 10);
            let filename;
            if (hasResults) {
                const scaledRes = document.getElementById('scaledResolution').textContent.replace(/ /g, '');
                filename = `EDID_Settings_${scaledRes}_${dateStr}.csv`;
            } else {
                filename = `EDID_Settings_${dateStr}.csv`;
            }

            // Detect if mobile device
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

            if (isMobile && navigator.share && navigator.canShare) {
                // Mobile: Use Web Share API
                const file = new File([blob], filename, { type: 'text/csv' });
                if (navigator.canShare({ files: [file] })) {
                    navigator.share({
                        files: [file],
                        title: 'EDID Settings',
                        text: 'OmniCalc EDID Settings Export'
                    }).catch(err => {
                        // User cancelled or share failed, fallback to download
                        downloadFile(blob, filename);
                    });
                } else {
                    downloadFile(blob, filename);
                }
            } else {
                // Desktop: Use download link
                downloadFile(blob, filename);
            }
        }

        function isInIframe() {
            try {
                return window.self !== window.top;
            } catch (e) {
                return true;
            }
        }

        function downloadFile(blob, filename) {
            // Try multiple download methods for maximum compatibility

            // Method 1: Try using msSaveOrOpenBlob for IE/Edge
            if (window.navigator && window.navigator.msSaveOrOpenBlob) {
                window.navigator.msSaveOrOpenBlob(blob, filename);
                return;
            }

            // Method 2: Convert blob to data URL
            const reader = new FileReader();
            reader.onload = function() {
                const dataUrl = reader.result;

                // If in iframe, show modal with download link
                if (isInIframe()) {
                    showFileDownloadModal(dataUrl, filename);
                    return;
                }

                // Standard download for non-iframe context
                const link = document.createElement('a');
                link.download = filename;
                link.href = dataUrl;
                link.style.display = 'none';
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                setTimeout(() => {
                    document.body.removeChild(link);
                }, 500);
            };
            reader.readAsDataURL(blob);
        }

        function importSettingsCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    const lines = csvContent.split('\n');
                    const settings = {};

                    // Parse CSV into key-value pairs
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        // Handle quoted values
                        let key, value;
                        if (line.includes(',"')) {
                            const match = line.match(/^([^,]+),\"(.*)\"$/);
                            if (match) {
                                key = match[1];
                                value = match[2].replace(/""/g, '"');
                            }
                        } else {
                            const commaIndex = line.indexOf(',');
                            if (commaIndex > -1) {
                                key = line.substring(0, commaIndex);
                                value = line.substring(commaIndex + 1);
                            }
                        }

                        if (key) {
                            settings[key] = value;
                        }
                    }

                    // Load System Configuration
                    if (settings['Connector']) {
                        state.connector = settings['Connector'];
                        document.getElementById('connector').value = settings['Connector'];
                    }

                    if (settings['Computer Model'] && settings['Computer Model'] !== 'Not Selected') {
                        state.computer = settings['Computer Model'];
                        document.getElementById('computer').value = settings['Computer Model'];
                    } else {
                        state.computer = '';
                        document.getElementById('computer').value = '';
                    }

                    if (settings['M-Series Chip'] && settings['M-Series Chip'] !== 'Not Selected') {
                        state.processor = settings['M-Series Chip'];
                    } else {
                        state.processor = '';
                    }

                    if (settings['macOS'] && settings['macOS'] !== 'Not Selected') {
                        state.macos = settings['macOS'];
                    } else {
                        state.macos = '';
                    }

                    if (settings['Connector Capacity']) {
                        state.capacity = settings['Connector Capacity'];
                        document.getElementById('capacity').value = settings['Connector Capacity'];
                    }

                    if (settings['Better Display']) {
                        state.betterDisplay = settings['Better Display'] === 'On';
                        document.getElementById('betterDisplay').checked = state.betterDisplay;
                    }

                    // Load Resolution Calculator Settings
                    if (settings['Display Width Input']) {
                        document.getElementById('displayWidth').value = settings['Display Width Input'];
                    }

                    if (settings['Display Height Input']) {
                        document.getElementById('displayHeight').value = settings['Display Height Input'];
                    }

                    if (settings['Frame Rate']) {
                        document.getElementById('frameRate').value = settings['Frame Rate'];
                    }

                    if (settings['Bit Rate']) {
                        state.bitRate = settings['Bit Rate'];
                        document.getElementById('bitRate').value = settings['Bit Rate'];
                    }

                    if (settings['Chroma Subsampling']) {
                        state.chromaSubsampling = settings['Chroma Subsampling'];
                        document.getElementById('chromaSubsampling').value = settings['Chroma Subsampling'];
                    }

                    if (settings['Reduced Blanking']) {
                        document.getElementById('reducedBlanking').value = settings['Reduced Blanking'];
                    }

                    if (settings['Dual DP 1.2']) {
                        state.dualDp = settings['Dual DP 1.2'] === 'On';
                        document.getElementById('dualDp').checked = state.dualDp;
                    }

                    if (settings['Pixel Density Mode']) {
                        state.pixelDensityMode = settings['Pixel Density Mode'] === 'On';
                        document.getElementById('pixelDensityMode').checked = state.pixelDensityMode;
                        const maxVerticalInput = document.getElementById('maxVertical');
                        if (state.pixelDensityMode) {
                            maxVerticalInput.classList.remove('hidden');
                        } else {
                            maxVerticalInput.classList.add('hidden');
                        }
                    }

                    if (settings['Max Vertical'] && settings['Max Vertical'] !== 'N/A') {
                        document.getElementById('maxVertical').value = settings['Max Vertical'];
                    }

                    // Update UI
                    updateAllDropdowns();
                    updateDualDpState();
                    updateLimits();
                    clearResults();

                    showAlert('Import Successful', 'Settings have been loaded. Click CALCULATE to see results.');

                } catch (err) {
                    console.error('Import failed:', err);
                    showAlert('Import Failed', 'Unable to parse CSV file. Please check the file format.');
                }

                // Reset file input
                event.target.value = '';
            };

            reader.readAsText(file);
        }

        function showFileDownloadModal(dataUrl, filename) {
            // Create modal for file download (CSV/PPT)
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const modal = document.createElement('div');
            modal.id = 'fileDownloadModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                z-index: 2000;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;

            const title = document.createElement('h2');
            title.textContent = 'Your file is ready';
            title.style.cssText = 'color: white; margin-bottom: 20px;';
            modal.appendChild(title);

            const instruction = document.createElement('div');
            instruction.style.cssText = `
                color: rgba(255, 255, 255, 0.7);
                font-size: 16px;
                margin-bottom: 20px;
                text-align: center;
            `;
            if (isMobile) {
                instruction.textContent = 'Tap and hold the link below, then tap "Download Linked File"';
            } else {
                instruction.textContent = 'Right-click the link below and select "Download Linked File As..."';
            }
            modal.appendChild(instruction);

            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = filename;
            link.textContent = filename;
            link.style.cssText = `
                background: linear-gradient(90deg, rgb(220, 130, 70), rgb(240, 150, 90));
                color: white;
                padding: 15px 30px;
                border-radius: 10px;
                text-decoration: none;
                font-weight: 600;
                font-size: 16px;
            `;
            modal.appendChild(link);

            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Close';
            closeBtn.style.cssText = `
                margin-top: 30px;
                padding: 12px 40px;
                background: rgba(255, 255, 255, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.4);
                border-radius: 8px;
                color: white;
                font-size: 16px;
                cursor: pointer;
            `;
            closeBtn.onclick = () => modal.remove();
            modal.appendChild(closeBtn);

            // Close on background click
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };

            document.body.appendChild(modal);
        }

        function showExportModal(imageData, isIOS) {
            // Create modal for image saving
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const modal = document.createElement('div');
            modal.id = 'exportModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                z-index: 2000;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;

            const instruction = document.createElement('div');
            instruction.style.cssText = `
                color: white;
                font-size: 16px;
                margin-bottom: 15px;
                text-align: center;
            `;
            if (isMobile) {
                instruction.textContent = isIOS
                    ? 'Press and hold the image, then tap "Add to Photos"'
                    : 'Press and hold the image to save';
            } else {
                instruction.textContent = 'Right-click the image and select "Save Image As..."';
            }

            const img = document.createElement('img');
            img.src = imageData;
            img.style.cssText = `
                max-width: 90%;
                max-height: 70%;
                border-radius: 10px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            `;

            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Close';
            closeBtn.style.cssText = `
                margin-top: 20px;
                padding: 12px 40px;
                background: rgba(255, 255, 255, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.4);
                border-radius: 8px;
                color: white;
                font-size: 16px;
                cursor: pointer;
            `;
            closeBtn.onclick = () => modal.remove();

            modal.appendChild(instruction);
            modal.appendChild(img);
            modal.appendChild(closeBtn);
            document.body.appendChild(modal);

            // Also close on background tap
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }

        // ==========================================
        // COLLAPSIBLE SECTIONS
        // ==========================================

        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + 'Content');
            const chevron = document.getElementById(sectionId + 'Chevron');
            const title = chevron.parentElement;

            content.classList.toggle('collapsed');
            chevron.classList.toggle('collapsed');
            title.classList.toggle('collapsed-title');

            // Also collapse the divider after this section if it exists
            const nextDivider = content.nextElementSibling;
            if (nextDivider && nextDivider.classList.contains('divider')) {
                nextDivider.classList.toggle('collapsed-divider');
            }
        }

        // ==========================================
        // MODAL FUNCTIONS
        // ==========================================

        function showAlert(title, message) {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertModal').classList.add('active');
        }

        function closeAlert(event) {
            if (!event || event.target === document.getElementById('alertModal')) {
                document.getElementById('alertModal').classList.remove('active');
            }
        }

        function showEDIDTimings() {
            if (!state.edidTimings) return;

            const timings = state.edidTimings;
            const frameRate = document.getElementById('frameRate').value;
            const bitRate = document.getElementById('bitRate').value;

            // Get display resolution
            let resolution;
            const scaledRes = document.getElementById('scaledResolution').textContent;
            if (scaledRes === "No Scaling Needed") {
                const w = document.getElementById('displayWidth').value.trim();
                const h = document.getElementById('displayHeight').value.trim();
                resolution = `${w} x ${h}`;
            } else {
                resolution = scaledRes;
            }

            document.getElementById('edidSubtitle').textContent = `${resolution} @ ${frameRate}Hz - ${bitRate}`;

            document.getElementById('hTotal').textContent = timings.hTotal;
            document.getElementById('hFrontPorch').textContent = timings.hSyncOffset;
            document.getElementById('hActive').textContent = timings.hActive;
            document.getElementById('hSync').textContent = timings.hSyncWidth;
            document.getElementById('hPolarity').textContent = timings.hPolarity;

            document.getElementById('vTotal').textContent = timings.vTotal;
            document.getElementById('vFrontPorch').textContent = timings.vSyncOffset;
            document.getElementById('vActive').textContent = timings.vActive;
            document.getElementById('vSync').textContent = timings.vSyncWidth;
            document.getElementById('vPolarity').textContent = timings.vPolarity;
            document.getElementById('vRate').textContent = timings.vFreq.toFixed(2) + " Hz";

            document.getElementById('edidPixelClock').textContent = timings.pixelClock.toFixed(2) + " MHz";

            document.getElementById('edidModal').classList.add('active');
        }

        function closeEDIDModal(event) {
            if (!event || event.target === document.getElementById('edidModal')) {
                document.getElementById('edidModal').classList.remove('active');
            }
        }

        // ==========================================
        // VISUAL EFFECTS
        // ==========================================

        function blinkScreen() {
            const overlay = document.getElementById('blinkOverlay');
            overlay.classList.add('active');
            setTimeout(() => {
                overlay.classList.remove('active');
            }, 150);
        }

        // ==========================================
        // INITIALIZATION
        // ==========================================

        function init() {
            updateAllDropdowns();
            updateDualDpState();
            updateLimits();

            // Add keyboard support for Enter key on inputs
            document.getElementById('displayWidth').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('displayHeight').focus();
                }
            });

            document.getElementById('displayHeight').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    if (state.pixelDensityMode) {
                        document.getElementById('maxVertical').focus();
                    } else {
                        calculate();
                    }
                }
            });

            document.getElementById('maxVertical').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    calculate();
                }
            });
        }

        // Run initialization when DOM is ready
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
